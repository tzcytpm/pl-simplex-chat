name: SimpleX Android [Self-hosted, Container] (FAST)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: What type of build to trigger. Release builds MUST be ran from the `master` branch.
        required: true
        default: release
        type: choice
        options: [nightly, release]

concurrency:
  group: android-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-apk:
    runs-on: self-hosted

    # IMPORTANT: in container.image you must use a real Docker image tag, not "ubuntu-latest".
    container:
      image: ubuntu:24.04
      options: --init
      volumes:
        # Host persistent caches => fastest
        - /opt/android-sdk:/opt/android-sdk
        - /opt/gradle-cache:/opt/gradle-cache
        - /nix:/nix

    env:
      DEBIAN_FRONTEND: noninteractive

      # Your script + Nix often assumes USER/HOME exist
      USER: root
      HOME: /root

      # Persisted caches
      ANDROID_SDK_ROOT: /opt/android-sdk
      ANDROID_HOME: /opt/android-sdk
      GRADLE_USER_HOME: /opt/gradle-cache

      # Gradle speed knobs
      GRADLE_OPTS: >-
        -Dorg.gradle.daemon=true
        -Dorg.gradle.parallel=true
        -Dorg.gradle.caching=true
        -Dkotlin.incremental=true
        -Dorg.gradle.jvmargs=-Xmx4g

      ARCHES: aarch64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install minimal OS deps
        shell: bash
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates curl git unzip zip \
            openjdk-17-jdk bash xz-utils
          rm -rf /var/lib/apt/lists/*

      - name: Ensure Android SDK (zipalign) - install only if missing
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            cd /tmp
            curl -L -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
            unzip -q cmdline-tools.zip
            mv cmdline-tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            rm -f cmdline-tools.zip
          fi

          mkdir -p "$HOME/.android"
          : > "$HOME/.android/repositories.cfg" || true

          SDKM="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          "$SDKM" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
          "$SDKM" --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "build-tools;34.0.0"

          BT_DIR="$ANDROID_SDK_ROOT/build-tools/34.0.0"
          export PATH="$BT_DIR:$PATH"          # usable in THIS step
          echo "$BT_DIR" >> "$GITHUB_PATH"     # usable in NEXT steps
          zipalign -v || true                  # don't use -h

      # Use host Nix mount; do not install nix inside container
      - name: Configure Nix for container
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /etc/nix
          cat >/etc/nix/nix.conf <<'EOF'
          experimental-features = nix-command flakes
          max-jobs = auto
          sandbox = false
          build-users-group =
          EOF

          export PATH="/nix/var/nix/profiles/default/bin:$PATH"
          nix --version

      - name: Shim gradle -> gradlew
        shell: bash
        run: |
          set -euo pipefail
          chmod +x apps/multiplatform/gradlew
          ln -sf "$PWD/apps/multiplatform/gradlew" /usr/local/bin/gradle
          gradle --version

      - name: Build APK
        shell: bash
        run: |
          set -euo pipefail
          export PATH="/nix/var/nix/profiles/default/bin:$PATH"
          export NIX_CONFIG="show-trace = true"
          unset NIX_PATH || true
          chmod +x scripts/android/build-android.sh
          ./scripts/android/build-android.sh -s -g

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simplex-apks
          path: |
            simplex-chat-*.apk
            simplex-*.apk
