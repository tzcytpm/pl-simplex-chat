name: SimpleX Android Build (self-hosted, container, nix-in-container)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: What type of build to trigger. Release builds MUST be ran from the `master` branch.
        required: true
        default: release
        type: choice
        options: [nightly, release]

concurrency:
  group: android-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-apk:
    runs-on: self-hosted
    timeout-minutes: 180

    # NOTE: container.image must be a real Docker image tag.
    container:
      image: ubuntu:24.04
      options: --init

    env:
      DEBIAN_FRONTEND: noninteractive

      # Build script previously failed with USER unset
      USER: root
      HOME: /root

      # Use workspace-local caches (optional; change to host-mounted paths if you want)
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

      # Android SDK location inside container
      ANDROID_SDK_ROOT: /opt/android-sdk
      ANDROID_HOME: /opt/android-sdk

      # Gradle speed knobs (safe defaults)
      GRADLE_OPTS: >-
        -Dorg.gradle.daemon=true
        -Dorg.gradle.parallel=true
        -Dorg.gradle.caching=true
        -Dkotlin.incremental=true
        -Dorg.gradle.jvmargs=-Xmx4g

      # keep same as your previous runs
      ARCHES: aarch64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install OS dependencies
        shell: bash
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates curl git unzip zip xz-utils \
            bash \
            openjdk-17-jdk \
            file make g++ pkg-config \
            jq
          rm -rf /var/lib/apt/lists/*

      # (Optional) Better Gradle caching metadata; still useful even with GRADLE_USER_HOME in workspace
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install Android SDK cmdline-tools + build-tools (zipalign)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"

          if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            echo "Installing Android cmdline-tools..."
            cd /tmp
            curl -L -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
            unzip -q cmdline-tools.zip
            mv cmdline-tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            rm -f cmdline-tools.zip
          fi

          # sdkmanager sometimes wants this file present
          mkdir -p "$HOME/.android"
          : > "$HOME/.android/repositories.cfg" || true

          SDKM="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"

          # Accept licenses (non-fatal if already accepted)
          yes | "$SDKM" --sdk_root="$ANDROID_SDK_ROOT" --licenses >/dev/null || true

          # Install required tools
          "$SDKM" --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "build-tools;34.0.0"

          # Make zipalign available NOW + in later steps
          BT_DIR="$ANDROID_SDK_ROOT/build-tools/34.0.0"
          export PATH="$BT_DIR:$PATH"
          echo "$BT_DIR" >> "$GITHUB_PATH"

          # Verify zipalign (do NOT use -h)
          zipalign -v || true

      - name: Install Nix (single-user, no-daemon, container safe)
        shell: bash
        run: |
          set -euo pipefail
        
          # Ensure /nix exists (installer tries to use sudo if missing)
          mkdir -p /nix
          chmod 0755 /nix
          chown root:root /nix
        
          # Install Nix
          curl -L https://releases.nixos.org/nix/nix-2.22.0/install | bash -s -- --no-daemon
        
          # Load nix env
          . /root/.nix-profile/etc/profile.d/nix.sh
        
          # CI-friendly nix config
          mkdir -p /root/.config/nix
          cat >/root/.config/nix/nix.conf <<'EOF'
          experimental-features = nix-command flakes
          max-jobs = auto
          sandbox = false
          EOF
          
          nix --version

      - name: Shim gradle -> gradlew (project expects `gradle`)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x apps/multiplatform/gradlew
          ln -sf "$PWD/apps/multiplatform/gradlew" /usr/local/bin/gradle
          gradle --version

      - name: Build APKs
        shell: bash
        run: |
          set -euo pipefail

          # Make sure nix is available (prevents script from trying to install nix again)
          . /root/.nix-profile/etc/profile.d/nix.sh
          command -v nix
          nix --version

          chmod +x scripts/android/build-android.sh
          ./scripts/android/build-android.sh -s -g

      - name: Upload APK/AAB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simplex-android-${{ github.run_number }}
          path: |
            **/*.apk
            **/*.aab
