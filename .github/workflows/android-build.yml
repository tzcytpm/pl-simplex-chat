name: SimpleX Android - APK artifacts (matrix)

on:
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arches: aarch64
            abi: arm64-v8a
          - arches: armv7a
            abi: armeabi-v7a

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        shell: bash
        run: |
          sdkmanager --licenses <<<'y' >/dev/null || true

      - name: Install Android build-tools (zipalign)
        shell: bash
        run: |
          set -euo pipefail
          SDK_DIR="${ANDROID_HOME:-${ANDROID_SDK_ROOT:-}}"
          sdkmanager --install "platform-tools" "build-tools;34.0.0"
          echo "$SDK_DIR/build-tools/34.0.0" >> "$GITHUB_PATH"
          command -v zipalign

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip curl git

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Make build-android.sh detect Nix (CI-safe)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -L "$HOME/.nix-profile" ]]; then rm -f "$HOME/.nix-profile"; fi
          mkdir -p "$HOME/.nix-profile/etc/profile.d"
          cat > "$HOME/.nix-profile/etc/profile.d/nix.sh" <<'EOF'
          if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          fi
          EOF
          chmod 0644 "$HOME/.nix-profile/etc/profile.d/nix.sh"

      - name: Shim gradle -> gradlew
        run: |
          chmod +x apps/multiplatform/gradlew
          sudo ln -sf "$PWD/apps/multiplatform/gradlew" /usr/local/bin/gradle
          gradle --version

      - name: Build APK (${{ matrix.abi }})
        env:
          ARCHES: ${{ matrix.arches }}
        run: |
          set -euo pipefail
          chmod +x scripts/android/build-android.sh
          ./scripts/android/build-android.sh -s -g
          ls -lah simplex-chat-*.apk

      - name: Upload APK artifact (${{ matrix.abi }})
        uses: actions/upload-artifact@v4
        with:
          name: simplex-apk-${{ matrix.abi }}
          path: simplex-chat-${{ matrix.abi }}.apk
