name: SimpleX Android - APK artifacts

on:
  workflow_dispatch:
    inputs:
      mode:
        description: What type of build to trigger. Release builds MUST be ran from the `master` branch.
        required: true
        default: release
        type: choice
        options:
          - nightly
          - release

concurrency:
  group: android-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-apk:
    # ✅ self-hosted runner labels (edit to match yours)
    runs-on: [self-hosted, linux, x64]

    # ✅ ubuntu-latest baseline is 24.04 now; pin for stability/speed
    container:
      image: ubuntu:24.04
      options: --init
      volumes:
        # ✅ Persisted caches on the HOST (fastest)
        - /opt/android-sdk:/opt/android-sdk
        - /opt/gradle-cache:/opt/gradle-cache
        # ✅ If you want Nix to be fast, persist /nix on the host
        - /nix:/nix

    env:
      DEBIAN_FRONTEND: noninteractive

      # Use host-mounted caches
      ANDROID_SDK_ROOT: /opt/android-sdk
      ANDROID_HOME: /opt/android-sdk
      GRADLE_USER_HOME: /opt/gradle-cache

      # Gradle speed knobs (safe defaults)
      GRADLE_OPTS: >-
        -Dorg.gradle.daemon=true
        -Dorg.gradle.parallel=true
        -Dorg.gradle.caching=true
        -Dkotlin.incremental=true
        -Dorg.gradle.jvmargs=-Xmx4g

      # Your current build uses this
      ARCHES: aarch64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Keep OS deps minimal; remove repeated installs elsewhere
      - name: Install minimal OS deps
        shell: bash
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates curl git unzip zip \
            openjdk-17-jdk bash xz-utils
          rm -rf /var/lib/apt/lists/*

      # Better Gradle caching/summary than manual actions/cache
      # (Even with GRADLE_USER_HOME mounted, this helps with metadata + reporting.)
      - name: Set up Gradle environment
        uses: gradle/actions/setup-gradle@v4
      # GitHub docs also recommend this action for Gradle CI. :contentReference[oaicite:1]{index=1}

      - name: Ensure build-tools (zipalign) available
        shell: bash
        run: |
          set -euxo pipefail
      
          echo "== Who am I / permissions =="
          id
          ls -ld "$ANDROID_SDK_ROOT" || true
          mkdir -p "$ANDROID_SDK_ROOT" || true
          touch "$ANDROID_SDK_ROOT/.write_test" || (echo "SDK root not writable" && exit 1)
          rm -f "$ANDROID_SDK_ROOT/.write_test"
      
          echo "== Make sdkmanager happy in containers =="
          mkdir -p "$HOME/.android"
          touch "$HOME/.android/repositories.cfg" || true
      
          echo "== Install build-tools (zipalign) =="
          SDKM="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          "$SDKM" --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
          "$SDKM" --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "build-tools;34.0.0"
      
          echo "== Put build-tools on PATH =="
          BT_DIR="$(ls -d "$ANDROID_SDK_ROOT"/build-tools/* | sort -V | tail -n 1)"
          echo "$BT_DIR" >> "$GITHUB_PATH"
    
      # Android SDK: install ONLY if missing (after first run it's instant)
      - name: Ensure Android cmdline-tools + build-tools present (zipalign)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"

          if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            echo "Installing Android cmdline-tools (first run only)..."
            cd /tmp
            curl -L -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
            unzip -q cmdline-tools.zip
            mv cmdline-tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            rm -f cmdline-tools.zip
          fi

          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses >/dev/null || true
          "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
            "platform-tools" \
            "build-tools;34.0.0"

          echo "$ANDROID_SDK_ROOT/build-tools/34.0.0" >> "$GITHUB_PATH"

      - name: Install sudo (needed for install-nix-action)
        shell: bash
        run: |
          apt-get update
          apt-get install -y --no-install-recommends sudo
          rm -rf /var/lib/apt/lists/*

      # Install Nix in the container but reuse /nix via host mount (huge speedup after first run)
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            max-jobs = auto
      # install-nix-action CI defaults and extra_nix_config behavior. :contentReference[oaicite:2]{index=2}

      # Keep ONE nix visibility fix (your file had 2 overlapping steps)
      - name: Ensure nix is on PATH for scripts
        shell: bash
        run: |
          set -euo pipefail
          command -v nix
          nix --version
          ln -sf "$(command -v nix)" /usr/local/bin/nix || true
          # Your script expects /nix profile in PATH sometimes:
          export PATH="/nix/var/nix/profiles/default/bin:$PATH"
          command -v nix

      # Keep your gradle shim (script calls "gradle", not ./gradlew)
      - name: Shim gradle -> gradlew
        shell: bash
        run: |
          chmod +x apps/multiplatform/gradlew
          ln -sf "$PWD/apps/multiplatform/gradlew" /usr/local/bin/gradle
          gradle --version

      # Keep your nix-profile hack, but only if needed
      - name: Make build-android.sh detect Nix correctly (only if needed)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -L "$HOME/.nix-profile" ]]; then
            rm -f "$HOME/.nix-profile"
          fi
          mkdir -p "$HOME/.nix-profile/etc/profile.d"
          cat > "$HOME/.nix-profile/etc/profile.d/nix.sh" <<'EOF'
          if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          fi
          EOF
          chmod 0644 "$HOME/.nix-profile/etc/profile.d/nix.sh"

      - name: Build APK
        shell: bash
        env:
          USER: root
          HOME: /root
        run: |
          set -euo pipefail
          export PATH="/nix/var/nix/profiles/default/bin:$PATH"
          chmod +x scripts/android/build-android.sh
          ./scripts/android/build-android.sh -s -g

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simplex-apks
          path: |
            simplex-chat-*.apk
            simplex-*.apk
