name: SimpleX Android - APK artifacts

on:
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # SimpleX Android build uses Gradle + Nix-built libs
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK (for zipalign)
        uses: android-actions/setup-android@v3

      - name: Install Android build-tools (zipalign)
        shell: bash
        run: |
          sdkmanager --install "platform-tools" "build-tools;34.0.0"
          echo "${ANDROID_SDK_ROOT}/build-tools/34.0.0" >> $GITHUB_PATH
          zipalign -h >/dev/null

      - name: Install system deps (zip/unzip/curl)
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip curl git

      # Install Nix (SimpleX script uses nix build)
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      # Cache Gradle to speed up builds
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # The upstream script calls "gradle" (not ./gradlew).
      # We shim "gradle" to the repoâ€™s wrapper inside apps/multiplatform.
      - name: Shim gradle -> gradlew
        shell: bash
        run: |
          chmod +x apps/multiplatform/gradlew
          sudo ln -sf "$PWD/apps/multiplatform/gradlew" /usr/local/bin/gradle
          gradle --version

      - name: Build APKs using upstream script
        shell: bash
        run: |
          chmod +x scripts/android/build-android.sh
          # -s: build from current folder (do not clone)
          # -g: skip git operations inside script
          ./scripts/android/build-android.sh -s -g

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simplex-apks
          path: |
            simplex-chat-*.apk
            simplex-*.apk
