name: SimpleX Android - APK artifacts

on:
  workflow_dispatch:
    inputs:
        mode:
          description: What type of build to trigger. Release builds MUST be ran from the `master` branch.
          required: true
          default: release
          type: choice
          options:
            - nightly
            - release

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # SimpleX Android build uses Gradle + Nix-built libs
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK (for zipalign)
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        shell: bash
        run: |
          set -euo pipefail
          # Do NOT pipe `yes` under pipefail
          sdkmanager --licenses <<<'y' >/dev/null || true

      - name: Install Android build-tools (zipalign)
        shell: bash
        run: |
          set -euo pipefail
      
          SDK_DIR="${ANDROID_HOME:-${ANDROID_SDK_ROOT:-}}"
          if [[ -z "$SDK_DIR" ]]; then
            echo "ANDROID_HOME / ANDROID_SDK_ROOT not set"
            exit 1
          fi
          echo "SDK_DIR=$SDK_DIR"
      
          sdkmanager --install "platform-tools" "build-tools;34.0.0"
      
          echo "$SDK_DIR/build-tools/34.0.0" >> "$GITHUB_PATH"

      - name: Verify zipalign
        run: |
          which zipalign
          zipalign 2>&1 | head -n 5

      - name: Install system deps (zip/unzip/curl)
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip curl git

      # Install Nix (SimpleX script uses nix build)
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Verify Nix is available
        shell: bash
        run: |
          set -euo pipefail
          command -v nix
          nix --version

      - name: Expose nix in /usr/local/bin (avoid script re-install)
        shell: bash
        run: |
          set -euo pipefail
          NIX_BIN="$(command -v nix)"
          echo "NIX_BIN=$NIX_BIN"
          sudo ln -sf "$NIX_BIN" /usr/local/bin/nix
          # sanity
          /usr/local/bin/nix --version

      # Cache Gradle to speed up builds
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # The upstream script calls "gradle" (not ./gradlew).
      # We shim "gradle" to the repoâ€™s wrapper inside apps/multiplatform.
      - name: Shim gradle -> gradlew
        shell: bash
        run: |
          chmod +x apps/multiplatform/gradlew
          sudo ln -sf "$PWD/apps/multiplatform/gradlew" /usr/local/bin/gradle
          gradle --version

      - name: Make nix globally visible
        shell: bash
        run: |
          set -euo pipefail
          NIX_BIN="$(command -v nix)"
          echo "NIX_BIN=$NIX_BIN"
          sudo ln -sf "$NIX_BIN" /usr/bin/nix
          sudo ln -sf "$NIX_BIN" /usr/local/bin/nix
          /usr/bin/nix --version
          command -v nix
          
      - name: Make build-android.sh detect Nix correctly
        shell: bash
        run: |
          set -euo pipefail
      
          # Ensure ~/.nix-profile points to the system profile used by nix-daemon installs
          if [[ ! -e "$HOME/.nix-profile" ]]; then
            ln -s /nix/var/nix/profiles/default "$HOME/.nix-profile"
          fi
      
          # Ensure the exact file the script checks exists:
          mkdir -p "$HOME/.nix-profile/etc/profile.d"
          cat > "$HOME/.nix-profile/etc/profile.d/nix.sh" <<'EOF'
          # Stub for CI: satisfy SimpleX build-android.sh check
          if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          fi
          EOF
      
          # sanity
          test -f "$HOME/.nix-profile/etc/profile.d/nix.sh"
          command -v nix
          nix --version
          
      - name: Build APK
        shell: bash
        run: |
          set -euo pipefail
          export PATH="/nix/var/nix/profiles/default/bin:$PATH"
          chmod +x scripts/android/build-android.sh
          ./scripts/android/build-android.sh -s -g

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simplex-apks
          path: |
            simplex-chat-*.apk
            simplex-*.apk
